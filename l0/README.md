# Демонстрационный сервис заказов (wb-tech-l0)

## Описание

Это демонстрационный микросервис на Go, который показывает работу с Kafka, PostgreSQL и кешем. Сервис получает данные о заказах из очереди сообщений (Kafka), сохраняет их в базу данных (PostgreSQL), кеширует в памяти для быстрого доступа и предоставляет HTTP API и простой веб-интерфейс для просмотра информации о заказе по его ID.

---

## Основные возможности

- **Получение заказов из Kafka**: сервис подписывается на топик Kafka и обрабатывает входящие сообщения с заказами.
- **Валидация и обработка ошибок**: сообщения валидируются, невалидные — логируются и игнорируются.
- **Сохранение заказов в PostgreSQL**: при получении валидного заказа он сохраняется в БД.
- **Кеширование заказов**: последние полученные заказы хранятся в кэше, что ускоряет повторные запросы.
- **HTTP API**: эндпоинт для получения заказа по его UID (`GET /api/order/<order_uid>`), отдаёт JSON.
- **Веб-интерфейс**: простая страница, где можно ввести ID заказа и получить по нему информацию.
- **Гибкая архитектура**: через registry можно легко добавлять новые реализации брокеров, хранилищ и кешей.
- **Graceful shutdown**: сервис корректно завершает работу, закрывая все соединения и сервисы.
- **Логирование**: подробные логи для отладки и мониторинга.

---

## Структура проекта

```
.
├── cmd/                # Точка входа (main.go)
├── internal/
│   ├── app/            # Логика инициализации и управления жизненным циклом приложения
│   ├── broker/         # Брокеры
│   ├── cache/          # Кэши
│   ├── config/         # Загрузка и валидация основного конфига приложения из env
│   ├── logger/         # Интерфейс логгера
│   ├── models/         # Модели данных
│   ├── registry/       # Реализация registry для сервисов
│   ├── server/         # HTTP сервер, роутер, хэндлеры
│   └── storage/        # Базы данных
├── migrations/         # SQL-миграции для создания таблиц
├── frontend/           # Веб-интерфейс (HTML, nginx)
├── docker-compose.yml  # Docker Compose для локального запуска
├── Dockerfile          # Dockerfile для backend
└── README.md           # Этот файл
```

---

## Как запустить

### 1. Клонируйте репозиторий

```sh
git clone <ссылка>
cd l0
```

### 2. Создайте файл `.env`

Пример содержимого есть в .env.example

### 3. Запустите сервисы через Docker Compose

```sh
docker-compose up --build
```

- Backend будет доступен на `http://localhost:8080`
- Frontend (веб-интерфейс) — на `http://localhost:8081`

### 4. Проверьте работу

- Для проверки API:  
  `GET http://localhost:8080/api/order/<order_uid>`
- Для проверки интерфейса:  
  Откройте `http://localhost:8081`, введите order_uid и получите данные.

---

## Как работает сервис (flow заказа)

1. **Получение заказа**:  
   Сервис подписывается на Kafka и ждёт новых сообщений с заказами.

2. **Валидация**:  
   Сообщение парсится в структуру заказа и валидируется. Если невалидно — логируется и игнорируется.

3. **Сохранение**:  
   Валидный заказ сохраняется в PostgreSQL (используются транзакции, чтобы не терять данные).

4. **HTTP API**:  
   При запросе `/api/order/<order_uid>`:
   - Сначала ищет в кеше.
   - Если нет — берёт из БД, кладёт в кеш и отдаёт.
   - Если не найден — 404.

---

## Registry

В проекте используется паттерн registry для сервисов (брокер, хранилище, кеш). Это позволяет легко добавлять новые реализации (например, другой кеш или брокер) — достаточно зарегистрировать их в registry и указать нужный тип в переменных окружения.

---

## Graceful shutdown

Сервис корректно завершает работу:
- Ловит сигналы завершения (SIGINT, SIGTERM).
- Закрывает HTTP сервер, соединения с БД, брокером и кешем.
- Ждёт завершения всех операций с таймаутом (`SHUTDOWN_TIMEOUT`).

---

## Миграции

Миграции для создания таблиц лежат в папке `migrations/`.  
Они автоматически применяются контейнером `migrate` при запуске через docker-compose.

---

## Веб-интерфейс

- Находится в папке `frontend/`.
- Работает через nginx, обращается к backend по API.
- Позволяет ввести order_uid и получить по нему заказ.

---

## Пример запроса

```
GET http://localhost:8080/api/order/b563feb7b2b84b6test
```

Ответ — JSON с полной структурой заказа.

---

## Возможности для расширения

- Легко добавить новые реализации брокеров, кешей, хранилищ (через registry).
- Можно добавить сбор логов, метрик, их визуализацию

---
